---
import { type CollectionEntry, getCollection } from "astro:content";
import SocialList from "@/components/SocialList.astro";
import PostPreview from "@/components/blog/PostPreview.astro";
import Note from "@/components/note/Note.astro";
import ProjectCard from "@/components/project/ProjectCard.astro";
import { getAllPosts } from "@/data/post";
import { getAllVideos } from "@/data/video";
import { YouTube } from "astro-embed";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort, getFormattedDate } from "@/utils/date";

// Posts
const MAX_POSTS = 10;
const allPosts = await getAllPosts();

const allVideos = await getAllVideos();

const allPostsByDate = allPosts
	.sort(collectionDateSort)
	.slice(0, MAX_POSTS) as CollectionEntry<"post">[];

// Pinned Posts, set to a max of 3;
const MAX_PINNED_POSTS = 3;
const pinnedPosts = allPostsByDate.filter((p) => p.data.pinned).slice(0, MAX_PINNED_POSTS);
const nonPinnedPosts = allPostsByDate.filter((p) => !p.data.pinned);
const combinedPosts = [...pinnedPosts, ...nonPinnedPosts];

// Notes
const MAX_NOTES = 3;
const allNotes = await getCollection("note");
const latestNotes = allNotes.sort(collectionDateSort).slice(0, MAX_NOTES);

// Projects (show only one, above Posts)
const allProjects = await getCollection("project");
const latestProject = allProjects
	.sort((a, b) => (b.data.publishDate?.getTime() ?? 0) - (a.data.publishDate?.getTime() ?? 0))
	.slice(0, 1);
---

<PageLayout meta={{ title: "Home" }}>
	<section>
		<h2 class="title mb-12">Hello World!</h2>
		<p class="mb-4">
			Hi, I’m a theme for Astro, a simple starter that you can use to create your website or blog.
			If you want to know more about how you can customise me, add more posts, and make it your own,
			click on the GitHub icon link below and it will take you to my repo.
		</p>
		<SocialList />
	</section>
	<section class="mt-16">
		<h2 class="title text-accent mb-4 text-xl">Videos</h2>
		<ul class="flex flex-wrap items-start gap-12">
			{
				allVideos.slice(0, 2).map((video) => (
					<li class="w-72 overflow-hidden">
						<YouTube id={video.url} class="w-72 rounded-xl" />
						<div class="mt-2 flex items-center">
							<div class="text-accent text-xs">{getFormattedDate(new Date(video.publishDate))}</div>
							<div class="flex-1" />
							{video.conference && (
								<div class="bg-accent text-bgColor rounded px-2 py-1 text-xs font-bold">
									{video.conference}
								</div>
							)}
						</div>
						<h4 class="text-accent-2 mt-2 h-10 overflow-hidden font-bold text-ellipsis">
							<a class="cactus_link" href={video.url} target="_blank">
								{video.title}
							</a>
						</h4>
					</li>
				))
			}
		</ul>
		<ul class="mt-6 space-y-4">
			{
				allVideos.slice(2).map((video) => (
					<li class="grid gap-2 sm:grid-cols-[auto_1fr] sm:[&_q]:col-start-2">
						<div class="min-w-[120px] text-gray-600 dark:text-gray-400">
							{getFormattedDate(new Date(video.publishDate))}
						</div>
						<a class="cactus-link" href={video.url} target="_blank">
							{video.title}
						</a>
					</li>
				))
			}
		</ul>
	</section>
	{
		latestProject.length > 0 && (
			<section class="mt-16">
				<div class="mb-6 flex items-center justify-between">
					<h2 class="title text-accent text-xl">Projects</h2>
					<a class="hover:text-link" href="/projects/">
						View all <span aria-hidden="true">→</span>
					</a>
				</div>
				<ul class="space-y-8 text-start" role="list">
					<li>
						<ProjectCard project={latestProject[0]} />
					</li>
				</ul>
			</section>
		)
	}
	<section class="mt-16">
		<div class="mb-6 flex items-center justify-between">
			<h2 class="title text-accent text-xl">Posts</h2>
			<a class="hover:text-link" href="/posts/">
				View all <span aria-hidden="true">→</span>
			</a>
		</div>
		<ul class="space-y-4" role="list">
			{
				combinedPosts.map((p) => (
					<li class="grid gap-1 sm:grid-cols-[auto_1fr]">
						<PostPreview post={p} showPinnedLabel />
					</li>
				))
			}
		</ul>
	</section>
	{
		latestNotes.length > 0 && (
			<section class="mt-16">
				<div class="mb-6 flex items-center justify-between">
					<h2 class="title text-accent text-xl">Notes</h2>
					<a class="hover:text-link" href="/notes/">
						View all <span aria-hidden="true">→</span>
					</a>
				</div>
				<ul class="mt-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" role="list">
					{latestNotes.map((note) => (
						<li>
							<Note note={note} as="h3" isPreview />
						</li>
					))}
				</ul>
			</section>
		)
	}
</PageLayout>
